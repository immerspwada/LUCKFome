<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="config.js"></script>
</head>
<body>
    <div style="text-align:center; margin: 18px 0 0 0; color: #ff8800; font-size: 1.2rem; font-weight: bold; letter-spacing: 1px;">‡∏£‡πâ‡∏≤‡∏ô LUCKY KOLOK</div>
    <h2>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2>
    <div class="payment-box">
      <h2>‡∏™‡πÅ‡∏Å‡∏ô‡∏õ‡∏∏‡πä‡∏ö ‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏±‡πä‡∏ö üê±üí∏</h2>
      <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</strong> ‡∏°‡∏µ‡∏ô‡∏£‡∏ç‡∏≤‡∏ì‡πå ‡∏û‡∏£‡∏´‡∏°‡πÄ‡∏û‡∏ä‡∏£</p>
      <p><strong>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</strong> 720-1-11288-5</p>
      <p><strong>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</strong> ‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ (Krungsri)</p>
      <img src="qr-code-image.png" alt="QR ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå" width="200" onerror="this.style.display='none';document.getElementById('qr-error').style.display='block';">
      <div id="qr-error" style="display:none;color:#ff3b30;font-weight:bold;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå QR ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå!</div>
      <p>üì± <strong>PromptPay</strong> ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</p>
      <p>üôè <strong>‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏≠‡∏∏‡∏î‡∏´‡∏ô‡∏∏‡∏ô</strong> ‚Äî Thank you</p>
    </div>
    <div style="margin:24px 0 12px 0;">
      <label style="font-weight:500;">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:
        <input type="file" id="slip-input" accept="image/*" style="margin-top:8px;">
      </label>
      <div id="slip-preview-box" style="margin-top:10px;display:none;">
        <img id="slip-preview" src="" alt="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏•‡∏¥‡∏õ" style="max-width:220px;max-height:220px;border-radius:10px;border:1.5px solid #ffb347;box-shadow:0 2px 8px rgba(255,136,0,0.10);">
      </div>
    </div>
    <button id="notify-btn" style="margin-top:18px;background:linear-gradient(90deg,#ff8800 60%,#ffb347 100%);color:#fff;border:none;border-radius:12px;padding:14px 40px;font-size:1.15rem;font-weight:600;cursor:pointer;box-shadow:0 2px 12px rgba(255,136,0,0.13);">‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
    <button id="back-btn" style="margin-top:12px;">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
    
    <div id="popup-modal" style="display:none;position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);align-items:center;justify-content:center;">
      <div style="background:#fffbe7;border:2px solid #ffb347;border-radius:16px;max-width:320px;padding:32px 18px 18px 18px;box-shadow:0 2px 12px rgba(255,136,0,0.18);text-align:center;">
        <div id="popup-message" style="color:#ff8800;font-size:1.12rem;font-weight:500;margin-bottom:18px;"></div>
        <button id="popup-close" style="background:linear-gradient(90deg,#ff8800 60%,#ffb347 100%);color:#fff;border:none;border-radius:10px;padding:8px 32px;font-size:1.08rem;font-weight:600;cursor:pointer;">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
    <script>
      function showPopup(msg, cb) {
        document.getElementById('popup-message').textContent = msg;
        document.getElementById('popup-modal').style.display = 'flex';
        document.getElementById('popup-close').onclick = function() {
          document.getElementById('popup-modal').style.display = 'none';
          if (cb) cb();
        };
      }
      document.getElementById('back-btn').onclick = function() {
        window.location.href = 'cart.html';
      };
      document.getElementById('slip-input').onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(evt) {
            document.getElementById('slip-preview').src = evt.target.result;
            document.getElementById('slip-preview-box').style.display = 'block';
          };
          reader.readAsDataURL(file);
        } else {
          document.getElementById('slip-preview-box').style.display = 'none';
        }
      };
      document.getElementById('notify-btn').onclick = async function() {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        if (cart.length === 0) {
          showPopup('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå');
          return;
        }
        let summary = '‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô\n';
        cart.forEach(item => {
          summary += `${item.name} x${item.qty} = ${item.price * item.qty} ‡∏ö‡∏≤‡∏ó\n`;
        });
        summary += `‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${cart.reduce((sum, item) => sum + item.price * item.qty, 0)} ‡∏ö‡∏≤‡∏ó\n`;
        summary += '\n‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ‡∏°‡∏µ‡∏ô‡∏£‡∏ç‡∏≤‡∏ì‡πå ‡∏û‡∏£‡∏´‡∏°‡πÄ‡∏û‡∏ä‡∏£\n‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: 720-1-11288-5 (‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ)';
        const slipInput = document.getElementById('slip-input');
        const slipFile = slipInput.files[0];
        let userId = '', displayName = '';
        if (window.liff) {
          try {
            await liff.init({ liffId: '2006986568-yjrOkKqm' });
            if (!liff.isLoggedIn()) {
              liff.login();
              return;
            }
            const profile = await liff.getProfile();
            userId = profile.userId || '';
            displayName = profile.displayName || '';
          } catch (e) {
            showPopup('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE LIFF: ' + e.message);
            return;
          }
        } else {
          showPopup('‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ö‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ LINE OA ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
          return;
        }
        if (!slipFile) {
          showPopup('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô');
          return;
        }
        const reader = new FileReader();
        reader.onload = async function(evt) {
          // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÑ‡∏õ Google Sheet
          const orderData = {
            userId,
            displayName,
            summary,
            slipBase64: evt.target.result, // ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏™‡πà‡∏á slipUrl ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏ö upload ‡∏à‡∏£‡∏¥‡∏á
            createdAt: new Date().toISOString(),
            status: 'pending'
          };
          // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Apps Script Web API (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô form-data ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏ö CORS)
          try {
            const formData = new FormData();
            formData.append('data', JSON.stringify(orderData));
            const res = await fetch(GOOGLE_APPS_SCRIPT_URL, {
              method: 'POST',
              body: formData
            });
            const result = await res.json();
            if (result.result === 'success') {
              try {
                liff.sendMessages([
                  { type: 'text', text: summary }
                ]).then(() => {
                  localStorage.removeItem('cart');
                  showPopup('‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÅ‡∏ä‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', function() {
                    window.location.href = 'receipt.html';
                  });
                }).catch(err => {
                  showPopup('‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÅ‡∏ä‡∏ó LINE ‡πÑ‡∏î‡πâ: ' + err.message + '\n‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏ä‡∏ó LINE OA ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', function() {
                    window.location.href = 'receipt.html';
                  });
                });
              } catch (e) {
                localStorage.removeItem('cart');
                showPopup('‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', function() {
                  window.location.href = 'receipt.html';
                });
              }
            } else {
              showPopup('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheet');
            }
          } catch (e) {
            showPopup('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheet: ' + e.message);
          }
        };
        reader.readAsDataURL(slipFile);
      };
        </script>
</body>
</html>
